## 1. Reconnaissance

HTB每周会有新靶机发布（machine release),可在靶机Info Card里获取信息：OS,Difficulty,Points,Release Date,IP,Machine Maker(s)。

------

**Scenario 1**:  已知靶机IP: 10.10.x.x，如何获取相关信息？

**Solve:** 

   相关知识点：[Active Scanning](https://attack.mitre.org/techniques/T1595)，[Gather Victim Network Information](https://attack.mitre.org/techniques/T1590).

- ```shell
  # Official Writeup way
  ports=$(nmap -p- --min-rate=1000 -T4 10.10.x.x | grep ^[0-9] | cut -d'/' -f1 | tr '\n' ',' | sed s/,$//)
  nmap -sC -sV -p$ports 10.10.x.x
  ```
  
- ```shell
  # Another way,my way
  masscan -e tun0 -p1-65535,U:1-65535 10.10.x.x --rate=1000 -oL /tmp/masscan.list
  tcpPorts=$(cat /tmp/masscan.list | grep "open tcp" | cut -d' ' -f3 | tr '\n' ',' | sed s/,$//)
  nmap -sC -sV -A -p$tcpPorts 10.10.x.x
  ```

- ```shell
  # UDP
  udpPorts=$(cat /tmp/masscan.list | grep "open udp" | cut -d' ' -f3 | tr '\n' ',' | sed s/,$//)
  nmap -sC -sV -A -sU -p$udpPorts 10.10.x.x
  ```

**Scenario 2**: 已知nmap扫描信息如下，基于此还能获取什么？

```shell
nmap -A -sC -sV -p 21,22,80 10.10.x.x

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 2.0.8 or later
| ssl-cert: Subject: commonName=*.test.htb/organizationName=Test Ltd./stateOrProvinceName=NY/countryName=US
| Not valid before: 2020-04-30T19:16:46
|_Not valid after:  3991-08-16T19:16:46
|_ssl-date: TLS randomness does not represent time
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-server-header: Apache/2.4.38 (Debian)
|_http-title: Apache2 Debian Default Page: It works
Service Info: Host: Test; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

**Solve**: 

  针对某一具体端口时，可启用-vv参数。此例可深挖ssl证书信息，其他如443、8443、110端口同理。总之，nmap过处，一个bit都不放过。相关知识点：[Search Open Technical Databases: Digital Certificates](https://attack.mitre.org/techniques/T1596/003)

```shell
nmap -sC -sV -vv -p 21 10.10.x.x

PORT   STATE SERVICE REASON         VERSION
21/tcp open  ftp     syn-ack ttl 63 vsftpd 2.0.8 or later
| ssl-cert: Subject: commonName=*.test.htb/organizationName=Test Ltd./stateOrProvinceName=NY/countryName=US/emailAddress=info@sub.test.htb
| Issuer: commonName=*.test.htb/organizationName=Cross Fit Ltd./stateOrProvinceName=NY/countryName=US/emailAddress=info@sub.test.htb
```

**Scenario 3**: 已知靶机ip为10.10.x.x，域名test.htb，80/443端口open，一般情况下如何探测？

**Solve**：

  枚举子域名、网站目录、路径、备份及扩展名。

```shell
gobuster dir -u http://test.htb -w /usr/share/dirb/wordlists/common.txt -t 30 -s 200,204,301,302,307,401,403 -x html,htm,php,txt,zip,xml
gobuster dir -u http://test.htb/sub -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50
ffuf -u https://test.ht/FUZZ -w /usr/share/wordlists/dirb/common.txt
bfac --url http://test.htb
wfuzz -u http://test.htb/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-large-words-lowercase.txt -t 10

wfuzz -c -z list,"1-2-3-4-5" -H "HOST: FUZZ.test.htb" http://10.10.x.x
wfuzz -c --hw 933 -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -H "HOST: FUZZ.test.htb" http://10.10.x.x
# 其他字典
/usr/share/seclists/Discovery/Web-Content/raft-large-words-lowercase.txt
/usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
/usr/share/seclists/Discovery/DNS/dns-Jhaddix.txt
```

**Scenario 4**: 其他端口？

**Solve**:

对于HTB其他端口常见侦察如下。

```shell
# port 21,尝试匿名登录
ftp 10.10.x.x
# port 53
dig AXFR test.htb @10.10.x.x -p53 # dig -x 10.10.x.x
# port 88,枚举域用户名
nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm='MEGACORP.LOCAL',userdb=/usr/share/seclists/Usernames/Names/names.txt 10.10.x.x
# port 135，尝试获取网络接口
IOXIDResolver.py -t 10.10.x.x
# port 139/445,匿名获取share
smbclient -L //10.10.x.x/ -U "" -N # smbmap,cme,mount -t cifs...
# port 2049
showmount -e 10.10.x.x
mount -t nfs 10.10.x.x:/site_backups /mnt/backups -o nolock
# port 3128,Squid http proxy
proxychains ...
# port 22,23,389,1433,1521,3306,3389,5900,5985.In HTB，这些匿名登录少见爆破少见。
```



**Todo**: ...
